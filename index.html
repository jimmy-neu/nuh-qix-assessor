<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUH QIX Awards - Advanced Multi-Agent Assessor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #eef; padding-bottom: 10px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        textarea { font-family: inherit; resize: vertical; min-height: 100px; font-size: 0.9em; }
        button { background-color: #0056b3; color: white; border: none; cursor: pointer; font-size: 16px; width: 100%; padding: 15px; border-radius: 5px; transition: 0.3s; }
        button:hover { background-color: #004494; }
        #report { margin-top: 20px; border: 1px solid #e0e0e0; padding: 20px; background-color: #fff; border-radius: 5px; }
        .prompt-config { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #ccc; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #0056b3; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>NUH QIX Awards - Pre-screening</h1>
        
        <label for="apiKey">Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter API Key">

        <div class="prompt-config">
            <h3>Agent Configuration (Modify Prompts Below)</h3>
            
            <label>üü¢ Positive Assessor Prompt:</label>
            <textarea id="positivePrompt">Role: You are the 'Positive Assessor'. Find evidence of strengths, innovation, and proper methodology. Look for structured problem-solving (PDCA, Fishbone) and actual process change. Output a list titled 'Positive Findings'.</textarea>
            
            <label>üî¥ Negative Assessor Prompt:</label>
            <textarea id="negativePrompt">Role: You are the 'Negative Assessor'. Flag rule violations for Level 4 classification (IT-only projects, no measurement, trial only, etc.). Output a list titled 'Negative Findings' or 'No Level 4 criteria violations found.'</textarea>
            
            <label>üßê Independent Assessor Prompt:</label>
            <textarea id="independentPrompt">Role: You are the 'Independent Assessor'. Synthesize both reports. If Negative Findings identifies ANY valid Level 4 violation, the verdict MUST be Level 4. Output: 1. Verdict 2. Justification.</textarea>
        </div>

        <label for="fileInput">Select Project PDF:</label>
        <input type="file" id="fileInput" accept=".pdf">

        <button id="analyzeButton">Run Multi-Agent Analysis</button>
        <div class="loader" id="loader"></div>

        <h2>Assessment Report</h2>
        <div id="report">
            <p style="color:#999;">Final analysis will appear here with professional formatting...</p>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const analyzeButton = document.getElementById('analyzeButton');
        const loader = document.getElementById('loader');
        const reportDiv = document.getElementById('report');

        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return { inlineData: { data: await base64EncodedDataPromise, mimeType: file.type } };
        }

        async function runAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const fileInput = document.getElementById('fileInput');
            
            if (!apiKey || fileInput.files.length === 0) {
                alert("API Key and PDF file are required.");
                return;
            }

            loader.style.display = 'block';
            analyzeButton.disabled = true;
            reportDiv.innerHTML = '<em>Processing document...</em>';

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const baseModelConfig = { model: "gemini-1.5-flash" }; 
                const filePart = await fileToGenerativePart(fileInput.files[0]);

                // 1. Positive Agent
                const posModel = genAI.getGenerativeModel({ ...baseModelConfig, systemInstruction: document.getElementById('positivePrompt').value });
                const posRes = await posModel.generateContent(["Analyze:", filePart]);
                const posText = posRes.response.text();

                // 2. Negative Agent
                const negModel = genAI.getGenerativeModel({ ...baseModelConfig, systemInstruction: document.getElementById('negativePrompt').value });
                const negRes = await negModel.generateContent(["Analyze:", filePart]);
                const negText = negRes.response.text();

                // 3. Final Agent
                const indModel = genAI.getGenerativeModel({ ...baseModelConfig, systemInstruction: document.getElementById('independentPrompt').value });
                const finalRes = await indModel.generateContent(`POS: ${posText}\n\nNEG: ${negText}`);
                
                // RENDER AS HTML USING MARKED
                reportDiv.innerHTML = marked.parse(finalRes.response.text());

            } catch (error) {
                reportDiv.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
            } finally {
                loader.style.display = 'none';
                analyzeButton.disabled = false;
            }
        }

        analyzeButton.addEventListener('click', runAnalysis);
    </script>
</body>
</html>