<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUH QIX Awards - Multi-Agent Assessor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f7f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #eef;
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box; /* Important for consistent sizing */
        }
        input[type="file"] {
             width: 100%;
             padding: 12px;
             margin-bottom: 15px;
             border-radius: 5px;
             border: 1px solid #ddd;
             box-sizing: border-box;
             background: #f9f9f9;
        }
        button {
            background-color: #0056b3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #004494;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #report {
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap; /* Preserves formatting like newlines */
            font-family: monospace, serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #0056b3;
            width: 24px;
            height: 24px;
            animation: spin 1.5s linear infinite;
            display: none; /* Hidden by default */
            margin: 15px auto;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NUH Incredible Care QIX Awards - Multi-Agent Pre-screening</h1>
        <p>This tool uses a 3-agent system (Positive, Negative, Independent) to analyze a project PDF and determine its eligibility for a full evaluation.</p>

        <label for="apiKey">Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your Gemini API Key here">

        <label for="fileInput">Select a Project PDF:</label>
        <input type="file" id="fileInput" accept=".pdf">

        <button id="analyzeButton">Analyze Project (3-Step)</button>

        <div class="loader" id="loader"></div>

        <h2>Assessment Report</h2>
        <div id="report">
            <p>The final analysis report will appear here.</p>
        </div>
    </div>

    <script type="module">
        // IMPORTANT: The "import" statement must be at the top-level of the module.
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- 1. DEFINE AGENT PROMPTS ---

        const POSITIVE_ASSESSOR_PROMPT = `
Role: You are the 'Positive Assessor' for the NUH Incredible Care QIX Awards. Your sole responsibility is to find evidence of strengths, innovation, and proper methodology. You are optimistic and looking for any evidence that the project deserves to be evaluated.
Task: Analyze the provided project PDF and write a report identifying all evidence that the project is high-quality and avoids a Level 4 classification. Specifically, you must look for:
- Application of Improvement Methodologies: Is there evidence of structured problem-solving like a Value Stream Map, Gap Analysis, fishbone diagram, Brainstorming P.I.C.K Chart, or PDCA cycles?
- Actual Process Change: Does the project describe a real change in workflow, or is it just an IT-only project?
- Measurement & Results: Are there clear metrics, measurements, or documentation of results? Is there a 'before' and 'after'?
- Concrete Implementation: Does the project show a completed implementation, not just a trial, assessment, or service development plan?
Output Format: Your output must be a bullet-point list titled 'Positive Findings'. Each bullet point must contain the strength you found and the specific evidence or quote from the document that supports it.
        `;

        const NEGATIVE_ASSESSOR_PROMPT = `
Role: You are the 'Negative Assessor' for the NUH Incredible Care QIX Awards. Your sole responsibility is to be a strict auditor, flagging rule violations and missing criteria. You are looking only for reasons to classify the project as Level 4.
Task: Analyze the provided project PDF and identify if it meets ANY of the following strict criteria for a Level 4 classification.
Level 4 'Rejection' Criteria:
- A solution is already decided (thus not able to apply improvement methodologies).
- It is a simple just-do-it or straightforward project with solutions like video/print booklets, pamphlets, leaflets, sending reminders, or just reinforcing current processes.
- It is an IT project (including Excel or programming) that does not involve any actual process change.
- There is no measurement or documentation of standard work or results.
- It is a trial or assessment without a concrete implementation.
- It involves research, randomized control trials, or studies that have pre-empted an intervention.
- It is just the fine-tuning of new services during a setting-up phase.
- It's a service development plan like buying new equipment or starting a new service.
- It's a Regular operation review or fine-tuning (e.g., PAR level, slot allocations, schedules).
- It's an RCA (Root Cause Analysis) without meaningful supporting data or for a single incident.
- It's an implementation of Evidence-based practice without measurement.
Output Format: Your output must be a bullet-point list titled 'Negative Findings'. If you find any violations, you must state the criterion that was met and provide the specific evidence or quote from the document that proves it. If you find no violations, your output must be the single sentence: "No Level 4 criteria violations found."
        `;

        const INDEPENDENT_ASSESSOR_PROMPT = `
Role: You are the 'Independent Assessor' for the NUH Incredible Care QIX Awards. Your responsibility is to review the findings from the Positive and Negative Assessors and provide a holistic assessment and final verdict .
Task: You will receive two reports: 'Positive Findings' and 'Negative Findings.' Your job is to synthesize them and render the final decision.
Decision Logic: Read both reports carefully. Crucially, if the 'Negative Findings' report identifies ANY valid Level 4 violation, the project MUST be classified as Level 4. The 'Positive Findings' cannot override a clear rule violation. If and only if the 'Negative Findings' report states 'No Level 4 criteria violations found,' you will classify the project as 'NOT Level 4.'
Output Format: Your output MUST be structured in two parts:
1.  **Verdict:** State clearly in one sentence: "The project is classified as Level 4." OR "The project is NOT classified as Level 4 and is eligible for full evaluation."
2.  **Justification:** Provide a detailed, point-by-point analysis explaining your verdict.
    - If Level 4, state the specific Level 4 criterion that was violated, referencing the evidence from the Negative Assessor.
    - If NOT Level 4, state that the project does not meet any of the strict criteria, and you may use the 'Positive Findings' report to provide justification (e.g., "The project clearly applies improvement methodologies, as evidenced by...")
        `;

        // --- 2. GET UI ELEMENTS ---
        const analyzeButton = document.getElementById('analyzeButton');
        const loader = document.getElementById('loader');
        const reportDiv = document.getElementById('report');

        // --- 3. HELPER FUNCTION ---

        // Converts a File object to a GoogleGenerativeAI.Part object.
        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        // --- 4. MAIN ANALYSIS FUNCTION (3-Agent Workflow) ---

        async function runAnalysis() {
            let apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey.startsWith('"') && apiKey.endsWith('"')) {
                apiKey = apiKey.slice(1, -1);
            }

            if (!apiKey) {
                alert("Please enter your Gemini API Key.");
                return;
            }

            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert("Please select a PDF file.");
                return;
            }
            const file = fileInput.files[0];

            // Show loader and disable button
            loader.style.display = 'block';
            analyzeButton.disabled = true;
            reportDiv.innerHTML = '<p>Initializing assessment...</p>';

            try {
                // Initialize the base GenAI object
                const genAI = new GoogleGenerativeAI(apiKey);
                
                // We use gemini-1.5-pro as it's best for document analysis and reasoning
                const baseModelConfig = { model: "gemini-2.5-flash" };

                reportDiv.innerHTML = '<p>Status: Converting PDF for analysis...</p>';
                const filePart = await fileToGenerativePart(file);

                // --- STEP 1: Run Positive Assessor ---
                reportDiv.innerHTML = '<p>Status: Running üü¢ Positive Assessor...</p>';
                const positiveModel = genAI.getGenerativeModel({
                    ...baseModelConfig,
                    systemInstruction: POSITIVE_ASSESSOR_PROMPT
                });
                const positiveResult = await positiveModel.generateContent([
                    "Please analyze the following project PDF:", filePart
                ]);
                const positive_findings = positiveResult.response.text();

                // --- STEP 2: Run Negative Assessor ---
                reportDiv.innerHTML = '<p>Status: Running üî¥ Negative Assessor...</p>';
                const negativeModel = genAI.getGenerativeModel({
                    ...baseModelConfig,
                    systemInstruction: NEGATIVE_ASSESSOR_PROMPT
                });
                const negativeResult = await negativeModel.generateContent([
                    "Please analyze the following project PDF:", filePart
                ]);
                const negative_findings = negativeResult.response.text();

                // --- STEP 3: Run Independent Assessor ---
                reportDiv.innerHTML = '<p>Status: Running üßê Independent Assessor (Final Verdict)...</p>';
                const independentModel = genAI.getGenerativeModel({
                    ...baseModelConfig,
                    systemInstruction: INDEPENDENT_ASSESSOR_PROMPT
                });
                
                const independentPrompt = `
                Here are the two reports. Please render your final verdict.

                --- POSITIVE FINDINGS ---
                ${positive_findings}
                ---------------------------

                --- NEGATIVE FINDINGS ---
                ${negative_findings}
                ---------------------------
                `;

                // This agent only needs the text reports, not the PDF.
                const finalResult = await independentModel.generateContent(independentPrompt);
                const final_verdict = finalResult.response.text();

                // Display the FINAL report
                reportDiv.innerText = final_verdict;

            } catch (error) {
                console.error("API Error:", error);
                reportDiv.innerHTML = `<strong>An error occurred:</strong><br><br>${error.toString()}`;
            } finally {
                // Hide loader and re-enable button
                loader.style.display = 'none';
                analyzeButton.disabled = false;
            }
        }

        analyzeButton.addEventListener('click', runAnalysis);
    </script>
</body>
</html>